A deserialization vulnerability exists in Tendenci with the Helpdesk module enabled, affecting the version 15.3.11 and earlier. This vulnerability allows remote code execution (RCE) by a staff user due to using Python's pickle module on helpdesk /reports/ when the "saved_query" parameter is passed. The damage is contained to the user that your Tendenci application runs.

**Key Finding:** CVE-2020-14942 was incompletely patched. While `ticket_list()` was fixed to use safe JSON deserialization, the `run_report()` function still uses unsafe `pickle.loads()` on attacker-controlled data, allowing authenticated staff users to achieve Remote Code Execution.

**Permission Scoping:** The malicious code would run under the same user account as the Tendenci application, usually _www-data_ on your production server if you followed the tendenci readthedocs. The _www-data_ is a least-privilege user, it has only the read permission for the application, no write permission (except for file upload directory), and no execute permission.  the damage would be limited. 

## Vulnerability Details

### Affected Version
- **Version:** Tendenci 15.3.11 and earlier (all versions since incomplete CVE-2020-14942 patch)
- **Component:** `tendenci/apps/helpdesk/views/staff.py`
- **Functions:** `run_report()` (line 1062), `save_query()` (line 1222)

### Tendenci Role Hierarchy

| Level | Role | Description |
|-------|------|-------------|
| 0 | `is_superuser` | Highest privilege - full Django admin |
| 1 | `is_staff` | Staff member - can access helpdesk module |
| 2 | `profile.is_superuser` | Tendenci application superuser |
| 3 | `profile.is_staff` | Tendenci application staff |
| 4 | Authenticated User | Basic member access |
| 5 | Anonymous User | Public read-only access |

`is_staff` is a commonly assigned role (by a superuser) for helpdesk operators who manage support tickets - not system administrators. 

### Attack Chain

| Step | Action | Required Role | Endpoint |
|------|--------|---------------|----------|
| 1 | Authenticate | Staff (`is_staff=True`) | POST /login/ |
| 2 | Create malicious saved query | Staff | POST /helpdesk/save_query/ |
| 3 | Trigger pickle deserialization | Staff | GET /helpdesk/reports/{type}/?saved_query={id} |
| 4 | Arbitrary code execution | - | Server-side |

## Root Cause Analysis

### Primary Vulnerability: Incomplete Patch for CVE-2020-14942

**Location:** `tendenci/apps/helpdesk/views/staff.py`

The original CVE-2020-14942 patch only fixed `ticket_list()` but missed `run_report()`:

**PATCHED - ticket_list() (lines 763-764):**
```python
from base64 import b64decode
query_params = simplejson.loads(b64decode(saved_query.query))
#query_params = pickle.loads(b64decode(str(saved_query.query).encode()))  # COMMENTED OUT
```

**VULNERABLE - run_report() (lines 1060-1062):**
```python
import pickle
from base64 import b64decode
query_params = pickle.loads(b64decode(str(saved_query.query).encode()))  # STILL VULNERABLE
```

### Secondary Vulnerability: No Input Validation on save_query()

**Location:** `tendenci/apps/helpdesk/views/staff.py` (lines 1222-1234)

```python
def save_query(request):
    title = request.POST.get('title', None)
    shared = request.POST.get('shared', False) in ['on', 'True', True, 'TRUE']
    query_encoded = request.POST.get('query_encoded', None)

    if not title or not query_encoded:
        return HttpResponseRedirect(reverse('helpdesk_list'))

    # NO VALIDATION - attacker-controlled data stored directly
    query = SavedSearch(title=title, shared=shared, query=query_encoded, user=request.user)
    query.save()

    return HttpResponseRedirect('%s?saved_query=%s' % (reverse('helpdesk_list'), query.id))
save_query = staff_member_required(save_query)
```

**Root Cause:** The `query_encoded` parameter is stored directly in the database without any validation. When retrieved via `run_report()`, it's passed to `pickle.loads()`, enabling arbitrary code execution.


### Code Comparison (Patched vs Vulnerable)

| Function | Line | Deserialization | Status |
|----------|------|-----------------|--------|
| `ticket_list()` | 763 | `simplejson.loads()` | ✅ SAFE |
| `run_report()` | 1062 | `pickle.loads()` | ❌ VULNERABLE |

## Remediation

Update Tendenci to the version 15.3.12 or later.


## References

- Tendenci GitHub: https://github.com/tendenci/tendenci
- GHSA Report: https://github.com/tendenci/tendenci/security/advisories/GHSA-339m-4qw5-j2g3
- CVE-2020-14942: https://nvd.nist.gov/vuln/detail/CVE-2020-14942
- GitHub Advisory GHSA-jqmc-fxxp-r589: https://github.com/advisories/GHSA-jqmc-fxxp-r589
- Original Issue: https://github.com/tendenci/tendenci/issues/867
- CWE-502: https://cwe.mitre.org/data/definitions/502.html
- Python Pickle Security: https://docs.python.org/3/library/pickle.html#restricting-globals
