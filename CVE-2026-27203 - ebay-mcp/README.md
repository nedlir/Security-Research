# Environment Variable Injection Vulnerability in ebay-mcp

The `ebay_set_user_tokens` tool allows updating the `.env` file with new tokens. The `updateEnvFile` function in `src/auth/oauth.ts` blindly appends or replaces values without validating them for newlines or quotes. This allows an attacker to inject arbitrary environment variables into the configuration file.

### Impact
An attacker can inject arbitrary environment variables into the `.env` file. This could lead to:
- **Configuration Overwrites**: Attackers can overwrite critical settings like `EBAY_REDIRECT_URI` to hijack OAuth flows.
- **Denial of Service**: Injecting invalid configuration can prevent the server from starting.
- **Potential RCE**: In some environments, controlling environment variables (like `NODE_OPTIONS`) can lead to Remote Code Execution.

### Vulnerable Code
The vulnerability is in the `updateEnvFile` function in `src/auth/oauth.ts`. The function directly writes token values to the `.env` file without sanitizing them. An attacker can inject newlines and other characters to add new environment variables.

The vulnerable code is as follows:
```typescript
function updateEnvFile(updates: Record<string, string>): void {
  try {
    const envPath = join(process.cwd(), '.env');
    let envContent = existsSync(envPath) ? readFileSync(envPath, 'utf-8') : '';

    // Update each key-value pair
    for (const [key, value] of Object.entries(updates)) {
      const regex = new RegExp(`^${key}=.*$`, 'm');
      const newLine = `${key}="${value}"`;

      if (regex.test(envContent)) {
        envContent = envContent.replace(regex, newLine);
      } else {
        envContent += `\n${newLine}`;
      }
    }

    writeFileSync(envPath, envContent, 'utf-8');
  } catch (_error) {
    // ...
  }
}
```

### poc

1. Start the server 
2. Run `poc.py`.
3. Observe the `.env` file modification with the new ENV variables